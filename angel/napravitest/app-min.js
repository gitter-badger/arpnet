function numKeys(e){var t=0;for(var a in e)t++;return t}function Shuffle(e){for(var t,a,s=e.length;s;t=parseInt(Math.random()*s),a=e[--s],e[s]=e[t],e[t]=a);return e}function calculate(){FB.Canvas.scrollTo(0,0),$(".preresults,.populate,#last_step").hide();var e=$(".progress div"),t=[];$.each(e,function(e,a){val1=e+1;var s=$("#"+a.id).attr("style").replace(/[^0-9]/g,"");t[s]={},t[s].percents=s,t[s].id=val1});var a=t.reverse()[0];$(".results").show(),$("#result"+a.id).show();var s=(new Date).getTime();FB.login(function(e){if(e.authResponse){var t=e.authResponse.userID,i=e.authResponse.accessToken;$.post("//arpecop.net/angel/db2/insert",{key:$.gvar.id,value:"ok"},function(){}),$.getJSON("https://graph.facebook.com/"+t+"/friends?access_token="+i+"&callback=?",function(e){var t={};t.title=$(".appname").text(),t.descr=$(".description").text(),t.name=e.first_name,t.qtitle=$("#result"+a.id+" .lead").text(),t.qdescr=$("#result"+a.id+" .result_full").text(),t.image=$("#result"+a.id+" .result_image").attr("src"),t.image||(t.image=$(".page-header .img-rounded").attr("src")),FB.api("/me",{fields:"first_name,third_party_id"},function(){var e={app_id:"160206614136535",type:"napravitest:quiz",appurl:"http://apps.facebook.com/napravitest/"+$.gvar.id,url:"http://apps.facebook.com/napravitest/"+$.gvar.id,appname:"[★"+t.title+" ★]",title:"[★"+t.title+" ★]",image:"https://fbcdn-sphotos-a-a.akamaihd.net/hphotos-ak-prn2/t1/1781954_758614150816219_1108738241_n.jpg",description:t.descr,appid:"160206614136535",description:t.descr};$.post("//chimpsnap.herokuapp.com/"+s,e,function(){FB.api("me/objects/napravitest:quiz","post",{object:e},function(){}),FB.api("/me/friends",{fields:"installed"},function(e){$.each(e.data,function(e,a){a.installed&&$.getJSON("//arpecop.net/angel/db2/"+a.id+$.gvar.id,function(e){e.message&&($.post("//arpecop.net/angel/db2/insert",{key:a.id+""+$.gvar.id,value:"ok"},function(){}),$.post("https://graph.facebook.com/"+a.id+"/apprequests",{redirect_uri:$.gvar.id,access_token:"160206614136535|7-z4flqlZsKpNvVCj1R5ZVMffZk",message:"Направи теста - "+t.title},function(){}))})})})})});var i=[];$.each(e.data,function(e,t){i.push(t.id)});var r=Shuffle(i).slice(0,10);FB.ui({method:"apprequests",message:t.title+" Направи този тест",to:r},function(){})})}},{scope:"publish_stream"})}$.getJSON("src/cross.json",function(e){for(var t=Math.floor(64*Math.random()),a=t+5,s=[],i=[],r=t;a>=r;r++)s.push('<a href="https://apps.facebook.com/napravitest/'+e[r].id+'" target="_top" class="list-group-item">'+e[r].appid+"</a>"),i.push('<li><a href="https://apps.facebook.com/napravitest/'+e[r].id+'" target="_top">'+e[r].appid+"</a></li>");$.each(e,function(){}),$(".others").html(s.join("")),$(".others1").html(i.join(""))}),$(document).ready(function(){$("img").error(function(){$(this).remove()})}),window.fbAsyncInit=function(){FB.init({appId:"160206614136535",status:!0,cookie:!0,xfbml:!0,oauth:!0,channelUrl:"//arpecop.net/static/channel.html",frictionlessRequests:!0}),FB.Canvas.setAutoGrow(),$(".publish").on("click",function(){var e=$(this).attr("id");e=e.replace("share","");FB.login(function(e){if(e.authResponse){{e.authResponse.userID,e.authResponse.accessToken}FB.api("/me",{fields:"first_name,third_party_id"},function(e){var t={};t.title=$(".appname").text(),t.descr=$(".description").text(),t.name=e.first_name,t.image=$("#result"+$.gvar.id+" .result_image").attr("src"),t.image||(t.image=$(".page-header .img-rounded").attr("src")),t.qtitle=$("#result"+$.gvar.id+" .lead").text(),t.qdescr=$("#result"+$.gvar.id+" .result_full").text()})}},{scope:"publish_stream"})}),$.getJSON("//arpecop.net/angel/napravitest/data/"+$.gvar.id+".json",function(e){$(".appname").text(e.appname),$(".description").text(e.description);var t=[],a=1;$.each(e.quiz,function(e,s){var i=s.short,r=s.full,n=e+1;t.push('\n<div id="result'+a+'" class="row-fluid" style="display:none">\n	<img src="https://arpecop.net/angel/napravitest/data/images/'+e+'.jpg" class="result_image" style="float:right">\n	<p class="lead" class="result_title">'+i+'</p>\n	<p class="result_full">'+r+'</p>\n<div style="clear:both"><!--<a class="btn publish" id="share'+n+'">Сподели</a>--></div></div>'),a++}),$("#rezese").html(t.join(""));var s=[];$.gvar.order=1,$.gvar.next=2,$.gvar.allsteps=numKeys(e.questions)-1,$.gvar.step_percents=Math.round(100/$.gvar.allsteps),$.each(e.questions,function(e,t){if(e>0){s.push('  \n <div  style="" class="question" id="q'+e+'"><div class="lead1"><i class="icon-bookmark-empty"></i> '+t.question+'</div><div class="btn-group-vertical">');for(var a=1;a<numKeys(t);a++)s.push('	<button class="btn btn-default" value="'+a+'"><i class="icon-circle-blank btntoggler"></i><i class="icon-circle btntoggler"></i>&nbsp;'+t[a]+"</button>\n");var i="";e>0&&(i='style="display:none"'),s.push("</div> </div>")}else for(var a=1;a<numKeys(t);a++)$(".progress").append('<div class="bar bar-success" id="'+a+'" style="width: 1%;"></div>')}),$(".populate").html(s.join(""))})},function(e){var t,a="facebook-jssdk";e.getElementById(a)||(t=e.createElement("script"),t.id=a,t.async=!0,t.src="https://connect.facebook.net/en_US/all.js",e.getElementsByTagName("head")[0].appendChild(t))}(document),$(document).on("click",".btn-group-vertical button",function(){$(this).addClass("btn-info");var e=$(this).val();$(this).find(".btntoggler").toggle();var t=$(".progress #"+e).attr("style"),a=Math.round(t.replace(/[^0-9]/g,""))+$.gvar.step_percents;if($(".progress #"+e).css("width",a+"%"),$.gvar.allsteps==$.gvar.order)$("#q"+$.gvar.order).css({opacity:.25}),calculate(),FB.Canvas.setAutoGrow();else{var s=$("#q"+$.gvar.next).offset();FB.Canvas.scrollTo(0,s.top),$("#q"+$.gvar.order).animate({opacity:.25},{specialEasing:{width:"linear",height:"easeOutBounce"},complete:function(){$("#q"+$.gvar.next).css({opacity:1}),$.gvar.order++,$.gvar.next++}})}});